---
title: "QuaterData"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#total
library(DBI)
library(RSQLite)

temp<-dbConnect(SQLite(),dbname="Shire.db")

store<-dbGetQuery(temp,'SELECT count(patient_id)as num, product_name, POP_DESC
           FROM New_Patient
           group by product_name, POP_DESC
           order by POP_DESC,num')
store$percentage<-NA

for (i in seq(1,nrow(store),2)) {
  store$percentage[i]<-store$num[i] /(store$num[i+1]+store$num[i])
  store$percentage[i+1]<-store$num[i+1] /(store$num[i+1]+store$num[i])
}
for (i in seq(1,nrow(store),2)) {
restore<-data.frame('POP_DESC_NAME'=c(store$POP_DESC[seq(1,nrow(store),2)]),'XIIdra'=c(store$num[seq(1,nrow(store),2)]),
                    'Restasis'=c(store$num[seq(2,nrow(store),2)]),'total'=c(store$num[seq(1,nrow(store),2)]+store$num[seq(2,nrow(store),2)]),
                    'Percentage_XIIdra'=c(store$percentage[seq(1,nrow(store),2)]*100),'Percentage_Restasis'=c(store$percentage[seq(2,nrow(store),2)]*100))
}
new <- filter(restore, restore$total < 150)
desc <- "others"
xiidra_sum=0
restasis_sum=0
total_sum=0
percen_xi=0
percen_re=0

for (i in 1:nrow(new)){
  xiidra_sum=xiidra_sum+new$XIIdra[i]
  restasis_sum=restasis_sum+new$Restasis[i]
  total_sum=xiidra_sum + restasis_sum
  percen_xi=(xiidra_sum/total_sum)*100
  percen_re=(restasis_sum/total_sum)*100
} 
RESTORE<-add_row(restore, POP_DESC_NAME = desc, XIIdra = xiidra_sum, Restasis = restasis_sum, total=total_sum, Percentage_XIIdra=percen_xi, Percentage_Restasis=percen_re)
RESTORE <- filter(RESTORE, RESTORE$total > 150)

nrow(RESTORE)
desc <- "TOTAL"
xiidra_sum=0
restasis_sum=0
total_sum=0
percen_xi=0
percen_re=0

for (i in 1:nrow(RESTORE)){
  xiidra_sum=xiidra_sum+RESTORE$XIIdra[i]
  restasis_sum=restasis_sum+RESTORE$Restasis[i]
  total_sum=xiidra_sum + restasis_sum
  percen_xi=(xiidra_sum/total_sum)*100
  percen_re=(restasis_sum/total_sum)*100
} 
RESTORE<-add_row(RESTORE, POP_DESC_NAME = desc, XIIdra = xiidra_sum, Restasis = restasis_sum, total=total_sum, Percentage_XIIdra=percen_xi, Percentage_Restasis=percen_re)

```

```{r}
#2016 Q3
library(DBI)
library(RSQLite)

temp<-dbConnect(SQLite(),dbname="Shire.db")

store<-dbGetQuery(temp,'SELECT count(patient_id)as num, product_name, POP_DESC
           FROM New_Patient
where dispensed_date between "2016-07-01" and "2016-09-30" 
           group by product_name, POP_DESC
           order by POP_DESC,num')
store$percentage<-NA

for (i in seq(1,nrow(store),2)) {
  store$percentage[i]<-store$num[i] /(store$num[i+1]+store$num[i])
  store$percentage[i+1]<-store$num[i+1] /(store$num[i+1]+store$num[i])
}
for (i in seq(1,nrow(store),2)) {
restore<-data.frame('POP_DESC_NAME'=c(store$POP_DESC[seq(1,nrow(store),2)]),'XIIdra'=c(store$num[seq(1,nrow(store),2)]),
                    'Restasis'=c(store$num[seq(2,nrow(store),2)]),'total'=c(store$num[seq(1,nrow(store),2)]+store$num[seq(2,nrow(store),2)]),
                    'Percentage_XIIdra'=c(store$percentage[seq(1,nrow(store),2)]*100),'Percentage_Restasis'=c(store$percentage[seq(2,nrow(store),2)]*100))
}
new <- filter(restore, restore$total < 100)
desc <- "others"
xiidra_sum=0
restasis_sum=0
total_sum=0
percen_xi=0
percen_re=0

for (i in 1:nrow(new)){
  xiidra_sum=xiidra_sum+new$XIIdra[i]
  restasis_sum=restasis_sum+new$Restasis[i]
  total_sum=xiidra_sum + restasis_sum
  percen_xi=(xiidra_sum/total_sum)*100
  percen_re=(restasis_sum/total_sum)*100
} 
RESTORE<-add_row(restore, POP_DESC_NAME = desc, XIIdra = xiidra_sum, Restasis = restasis_sum, total=total_sum, Percentage_XIIdra=percen_xi, Percentage_Restasis=percen_re)
RESTORE <- filter(RESTORE , RESTORE $total > 56)

nrow(RESTORE)
desc <- "TOTAL"
xiidra_sum=0
restasis_sum=0
total_sum=0
percen_xi=0
percen_re=0

for (i in 1:nrow(RESTORE)){
  xiidra_sum=xiidra_sum+RESTORE$XIIdra[i]
  restasis_sum=restasis_sum+RESTORE$Restasis[i]
  total_sum=xiidra_sum + restasis_sum
  percen_xi=(xiidra_sum/total_sum)*100
  percen_re=(restasis_sum/total_sum)*100
} 
RESTORE<-add_row(RESTORE, POP_DESC_NAME = desc, XIIdra = xiidra_sum, Restasis = restasis_sum, total=total_sum, Percentage_XIIdra=percen_xi, Percentage_Restasis=percen_re)



```


```{r}
# "2016-07-01" and "2018-03-01"
data<-dbGetQuery(temp,'SELECT count(patient_id)as num, product_name,  dispensed_date
                        FROM New_Patient
                        where dispensed_date between "2016-07-01" and "2018-03-01" 
                       GROUP BY dispensed_date
                    order by dispensed_date')

library(tidyverse)
library(scales)
library(datetime)
library(lubridate)
library(ggplot2)
#ggplot(data=data_2016Q3,mapping=aes(x='dispensed_date',y='num'))+geom_point()+ scale_x_date(labels = date_format("%Y-%m-%d"))
data$dispensed_date <- as.POSIXct(data$dispensed_date) 
class(data$dispensed_date)
ggplot(data=data,aes(x=dispensed_date,y=num,color=product_name))+geom_line()+scale_x_datetime(date_breaks = "3 months")
```
